<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Object Detector Game for Kids</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
    /* ========= Kid-friendly background + UI base (no external assets) ========= */

:root {
  --fg: #eef2f7;
  --card-bg: rgba(17, 24, 39, 0.65);
  --card-border: rgba(255, 255, 255, 0.08);
  --shadow: 0 20px 60px rgba(0,0,0,0.35);

  /* lively but calm palette - more vibrant for kids */
  --accent-1: #22c55e;  /* bright green */
  --accent-2: #0ea5e9;  /* sky blue */
  --accent-3: #a78bfa;  /* fun violet */
  --accent-4: #f59e0b;  /* warm amber */
  --accent-5: #ef4444;  /* playful red */
  --accent-6: #fbbf24;  /* sunny yellow */
}

html, body, #root {
  height: 100%;
}

body {
  margin: 0;
  font-family: 'Comic Sans MS', 'Marker Felt', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; /* Kid-friendly fonts fallback */
  color: var(--fg);
  background: #0b0f13; /* fallback if animations disabled */
}

/* Main wrapper used by App.js */
.app-wrap {
  min-height: 100vh;
  position: relative;
  overflow: hidden;
  color: var(--fg);
}

/* ---------- Animated background layer ---------- */
.bg-anim {
  position: fixed;
  inset: 0;
  z-index: -1;
  background-image: url('6783234.jpg'); /* Replace with your uploaded JPG path; place in public folder */
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-attachment: fixed; /* Parallax-like effect for subtle movement */
  filter: saturate(1.1) brightness(1.05); /* Enhance vibrancy for kids */
  animation: gentleFloat 20s ease-in-out infinite alternate; /* Subtle floating animation */
}

/* Gentle floating animation for the background image */
@keyframes gentleFloat {
  0% { transform: translateY(0px) scale(1); }
  100% { transform: translateY(-10px) scale(1.02); }
}

/* Twinkling stars overlay for extra magic (using CSS particles) */
.twinkle-stars {
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: -1;
}

.star {
  position: absolute;
  background: #fff;
  border-radius: 50%;
  animation: twinkle 2s infinite ease-in-out;
}

.star:nth-child(1) { top: 20%; left: 10%; width: 2px; height: 2px; animation-delay: 0s; }
.star:nth-child(2) { top: 30%; left: 80%; width: 3px; height: 3px; animation-delay: 0.5s; }
.star:nth-child(3) { top: 60%; left: 20%; width: 1px; height: 1px; animation-delay: 1s; }
.star:nth-child(4) { top: 70%; left: 70%; width: 2px; height: 2px; animation-delay: 1.5s; }
.star:nth-child(5) { top: 10%; left: 50%; width: 4px; height: 4px; animation-delay: 0.2s; }
/* Add more .star classes as needed for density */

@keyframes twinkle {
  0%, 100% { opacity: 0.3; transform: scale(0.8); }
  50% { opacity: 1; transform: scale(1.2); }
}

/* Floating bubble/confetti layers with URL-encoded inline SVG - optional overlay */
.bg-anim::before,
.bg-anim::after {
  content: "";
  position: absolute;
  inset: -10%;
  background-repeat: no-repeat;
  animation: drift 28s ease-in-out infinite alternate;
  opacity: 0.1; /* Low opacity to not overpower the image */
}

/* Big soft bubbles (radial gradients) */
.bg-anim::before {
  background-image:
    radial-gradient(120px 120px at 10% 20%, var(--accent-2), transparent 60%),
    radial-gradient(180px 180px at 75% 12%, var(--accent-3), transparent 60%),
    radial-gradient(140px 140px at 85% 70%, var(--accent-1), transparent 60%);
  background-size: 45% 45%, 35% 35%, 40% 40%;
  background-position: 5% 10%, 80% 8%, 86% 72%;
}

/* Tiny confetti dots (SVG is percent-encoded so parsers don't complain) */
.bg-anim::after {
  background-repeat: repeat;
  background-size: 240px 240px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27240%27 height=%27240%27 viewBox=%270%200%20240%20240%27%3E%3Cg fill=%27none%27 stroke=%27white%27 stroke-opacity=%270.35%27 stroke-width=%273%27%3E%3Ccircle cx=%2730%27 cy=%2730%27 r=%274%27/%3E%3Ccircle cx=%27120%27 cy=%2760%27 r=%273%27/%3E%3Ccircle cx=%27210%27 cy=%2730%27 r=%274%27/%3E%3Ccircle cx=%2760%27 cy=%27120%27 r=%273%27/%3E%3Ccircle cx=%27180%27 cy=%27120%27 r=%273%27/%3E%3Ccircle cx=%2730%27 cy=%27210%27 r=%274%27/%3E%3Ccircle cx=%27120%27 cy=%27180%27 r=%273%27/%3E%3Ccircle cx=%27210%27 cy=%27210%27 r=%274%27/%3E%3C/g%3E%3C/svg%3E");
}

/* Gentle motion; honors reduced motion */
@keyframes drift {
  0%   { transform: translate3d(0, 0, 0) scale(1); }
  100% { transform: translate3d(0, -16px, 0) scale(1.02); }
}
@media (prefers-reduced-motion: reduce) {
  .bg-anim::before,
  .bg-anim::after { animation: none; }
  .bg-anim { animation: none; }
  .star { animation: none; }
}

/* ---------- Layout & cards ---------- */
.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 24px;
  position: relative; /* Ensure stars and overlays stay behind content */
  z-index: 1;
}

.card {
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  backdrop-filter: blur(6px);
  border-radius: 16px;
  box-shadow: var(--shadow);
}

/* ---------- Buttons: larger targets, high contrast ---------- */
.btn {
  padding: 12px 18px;             /* bigger tap target for kids */
  border-radius: 12px;
  border: none;
  font-weight: 800;
  letter-spacing: 0.2px;
  cursor: pointer;
  transition: transform 60ms ease, filter 160ms ease;
  font-size: 16px; /* Slightly larger text for kids */
}
.btn:active { transform: translateY(1px) scale(0.995); }
.btn:hover  { filter: brightness(1.06); }

/* Color helpers (optional) */
.btn-green { background: #10b981; color: #08110a; }
.btn-amber { background: #f59e0b; color: #1a1200; }
.btn-violet{ background: #a78bfa; color: #0b0820; }
.btn-grey  { background: #6b7280; color: #0e0e0e; }

/* ---------- Media (video/canvas) ---------- */
.media {
  width: 100%;
  border-radius: 14px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  background: #000;
}

/* ---------- Subtitle banner (captions) ---------- */
.sub-banner {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  padding: 14px 18px;
  background: rgba(0, 0, 0, 0.55);
  backdrop-filter: blur(3px);
  color: #fff;
  font-size: 19px;
  text-align: center;
  letter-spacing: 0.2px;
  z-index: 50;
  border-top: 3px solid var(--accent-1); /* Fun green border */
}

/* Optional halo when speaking (add/remove `speaking` on <body>) */
body.speaking .sub-banner {
  box-shadow: 0 0 0 0 rgba(255,255,255,0.55);
  animation: halo 1.2s ease-out infinite;
}
@keyframes halo {
  0%   { box-shadow: 0 0 0 0 rgba(255,255,255,0.45); }
  100% { box-shadow: 0 0 0 18px rgba(255,255,255,0); }
}

/* ---------- Header styles (your requested title) ---------- */
.page-header { margin-bottom: 12px; }
.page-title {
  font-size: clamp(22px, 2.2vw + 14px, 34px);
  font-weight: 900;
  letter-spacing: 0.2px;
  margin: 0;
  line-height: 1.2;
  background: linear-gradient(90deg, #22c55e, #0ea5e9, #a78bfa, #f59e0b, #ef4444);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  text-shadow: 0 1px 0 rgba(0,0,0,0.25);
  animation: rainbow 4s ease-in-out infinite alternate; /* Subtle rainbow shift */
}

@keyframes rainbow {
  0% { filter: hue-rotate(0deg); }
  100% { filter: hue-rotate(60deg); }
}

/* ---------- Headings & small helpers ---------- */
h1, h2, h3 { margin: 0 0 8px; }
small, .hint { opacity: 0.85; }

/* ========= Keep CRA demo selectors if anything still references them ========= */
.App { text-align: center; }
.App-logo { height: 40vmin; pointer-events: none; }
@media (prefers-reduced-motion: no-preference) {
  .App-logo { animation: App-logo-spin infinite 20s linear; }
}
@keyframes App-logo-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

/* Extra kid-friendly touches: Floating emoji-like elements if needed in JS, but CSS-only sparks */
.sparkle {
  position: absolute;
  width: 4px;
  height: 4px;
  background: var(--accent-6);
  border-radius: 50%;
  pointer-events: none;
  animation: sparkle-float 2s ease-out forwards;
}

@keyframes sparkle-float {
  0% { opacity: 1; transform: translateY(0) scale(0); }
  100% { opacity: 0; transform: translateY(-50px) scale(1); }
}

/* Override background to use provided image */
body, .bg-anim {
  background-image: url("6783234.jpg");
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
}

    </style>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <div class="twinkle-stars">
      <div class="star"></div>
      <div class="star"></div>
      <div class="star"></div>
      <div class="star"></div>
      <div class="star"></div>
    </div>
    <script type="text/babel">
    
    const API_BASE = "https://crucial-citizen-average-lawn.trycloudflare.com";

    async function fetchClasses() {
      const res = await fetch(API_BASE + "/classes");
      if (!res.ok) throw new Error("classes request failed");
      return res.json();
    }

    async function detectFrame(imageBlob) {
      const form = new FormData();
      form.append("image", imageBlob, "frame.jpg");
      let res;
      try {
        res = await fetch(API_BASE + "/detect", { method: "POST", body: form });
      } catch (e) {
        console.error("NETWORK error calling /detect:", e);
        throw new Error("detect request failed (network)");
      }
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        console.error("DETECT error status:", res.status, "body:", text);
        throw new Error(`detect request failed (status ${res.status})`);
      }
      return res.json();
    }

    async function fetchQuizOptions(correct, k = 4) {
      const params = new URLSearchParams({ correct, k: String(k) });
      const res = await fetch(API_BASE + "/quiz/options?" + params.toString());
      if (!res.ok) throw new Error("quiz options request failed");
      return res.json();
    }

    const { useEffect, useRef, useState } = React;

    function DetectionCanvas({ video, detections }) {
  const ref = useRef(null);

  useEffect(() => {
    const c = ref.current;
    if (!c || !video) return;
    const ctx = c.getContext("2d");
    if (!ctx) return;

    c.width = video.videoWidth;
    c.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, c.width, c.height);

    ctx.lineWidth = 2;
    ctx.font = "40px system-ui, sans-serif";
    detections.forEach(d => {
      const [x1, y1, x2, y2] = d.xyxy;
      ctx.strokeStyle = "#00ff88";
      ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
      const label = `${d.cls} ${(d.conf * 100).toFixed(0)}%`;
      const w = ctx.measureText(label).width + 8, h = 18;
      ctx.fillStyle = "rgba(0,0,0,0.6)";
      ctx.fillRect(x1, y1 - h, w, h);
      ctx.fillStyle = "#fff";
      ctx.fillText(label, x1 + 4, y1 - 5);
    });
  }, [video, detections]);

  return (
    <canvas
      ref={ref}
      style={{ width: "100%", borderRadius: 12, boxShadow: "0 6px 20px rgba(0,0,0,0.25)" }}
    />
  );
}

    function speak(text) {
  try {
    window.speechSynthesis.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.rate = 0.9;
    window.speechSynthesis.speak(utter);
  } catch (e) {}
}

function App() {
  const videoRef = useRef(null);
  const initRef = useRef(false);
  const [currentFacingMode, setCurrentFacingMode] = useState("environment");

  const [detections, setDetections] = useState([]);
  const [best, setBest] = useState(null);
  const [running, setRunning] = useState(false);
  const [latency, setLatency] = useState(null);
  const [classes, setClasses] = useState([]);
  const [subtitle, setSubtitle] = useState("");

  const [quizActive, setQuizActive] = useState(false);
  const [quizOptions, setQuizOptions] = useState([]);
  const [quizCorrectIndex, setQuizCorrectIndex] = useState(-1);
  const [quizSelected, setQuizSelected] = useState(-1);
  const [quizType, setQuizType] = useState("object");
  const [showQuizSelection, setShowQuizSelection] = useState(false);

  // SCORING
  const [score, setScore] = useState(0);

  const classColors = { brush: "Red and black", pen: "silver", perfume: "golden and black", smartwatch: "matte black", sunglasses: "Shiny black", cellphone: "shiny white", bottle: "Yellow", book: "Brown", laptop: "dark grey", cup: "Gray" };
  const classDescriptions = { brush: "A cleaning tool with bristles...", pen: "A writing instrument...", perfume: "A liquid with pleasant fragrance...", smartwatch: "A wearable device...", sunglasses: "Protective eyewear...", "cell phone": "A handheld communication device...", bottle: "A container for liquids...", book: "A collection of pages for reading...", laptop: "A portable computer...", cup: "A small container for drinking..." };
  const supportedClasses = Object.keys(classColors);

  const showSub = (text, ms = 3000) => {
    setSubtitle(text);
    setTimeout(() => setSubtitle(""), ms);
  };

  useEffect(() => {
    fetchClasses().then(d => setClasses(d.classes || [])).catch(() => {});
  }, []);

  const safePlay = async () => {
    if (videoRef.current) {
      try { await videoRef.current.play(); } catch (e) {}
    }
  };

  const startCamera = async (facingMode) => {
    if (videoRef.current?.srcObject) {
      videoRef.current.srcObject.getTracks().forEach(t => t.stop());
    }
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode, width: { ideal: 1280 }, height: { ideal: 720 } },
        audio: false
      });
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        videoRef.current.onloadedmetadata = async () => {
          await safePlay();
          setRunning(true);
          showSub(facingMode === "environment" ? "Back camera ready!" : "Front camera ready!", 2000);
        };
      }
    } catch (err) {
      showSub("Camera permission needed!");
    }
  };

  useEffect(() => {
    if (initRef.current) return;
    initRef.current = true;
    startCamera("environment");
  }, []);

  const switchCamera = () => {
    const newMode = currentFacingMode === "environment" ? "user" : "environment";
    setCurrentFacingMode(newMode);
    startCamera(newMode);
  };

  const setDetectionPaused = (paused) => {
    const v = videoRef.current;
    if (!v) return;
    if (paused) {
      v.pause();
      setRunning(false);
    } else {
      safePlay();
      setRunning(true);
    }
  };

  const captureAndDetect = async () => {
    const v = videoRef.current;
    if (!v || v.videoWidth === 0 || !running) return;

    const canvas = document.createElement("canvas");
    canvas.width = v.videoWidth;
    canvas.height = v.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(v, 0, 0);

    const blob = await (await fetch(canvas.toDataURL("image/jpeg", 0.7))).blob();

    const t0 = performance.now();
    try {
      const resp = await detectFrame(blob);
      const t1 = performance.now();
      setLatency(Math.round(t1 - t0));
      setDetections(resp.detections || []);
      setBest(resp.best || null);
    } catch (err) {}
  };

  useEffect(() => {
    let id;
    if (running) {
      const loop = () => {
        captureAndDetect();
        id = setTimeout(loop, 100);
      };
      loop();
    }
    return () => clearTimeout(id);
  }, [running]);

  const speakTop = () => {
    const name = best?.cls || detections[0]?.cls;
    if (name) speak(`I see a ${name}`);
  };

  // QUIZZES
  const startObjectQuiz = async () => {
    const name = best?.cls || detections[0]?.cls;
    if (!name) return showSub("No object detected!");

    try {
      const data = await fetchQuizOptions(name, 4);
      setQuizOptions(data.options);
      setQuizCorrectIndex(data.correct_index);
      setQuizType("object");
      setQuizActive(true);
      setShowQuizSelection(false);
      speak("What object is this?");
    } catch {
      showSub("Quiz failed");
    }
  };

  const startColorQuiz = () => {
    const name = best?.cls;
    if (!name || !supportedClasses.includes(name)) return showSub("Not supported");

    const correct = classColors[name];
    const others = Object.values(classColors).filter(c => c !== correct);
    const options = [...others.sort(() => 0.5 - Math.random()).slice(0, 3), correct].sort(() => 0.5 - Math.random());
    setQuizOptions(options);
    setQuizCorrectIndex(options.indexOf(correct));
    setQuizType("color");
    setQuizActive(true);
    setShowQuizSelection(false);
    speak("What is the color?");
  };

  const startDescriptionQuiz = () => {
    const name = best?.cls;
    if (!name || !supportedClasses.includes(name)) return showSub("Not supported");

    const correct = classDescriptions[name];
    const others = Object.values(classDescriptions).filter(d => d !== correct);
    const options = [...others.sort(() => 0.5 - Math.random()).slice(0, 3), correct].sort(() => 0.5 - Math.random());
    setQuizOptions(options);
    setQuizCorrectIndex(options.indexOf(correct));
    setQuizType("description");
    setQuizActive(true);
    setShowQuizSelection(false);
    speak("Choose the correct description");
  };

  const chooseAnswer = (idx) => {
    if (quizSelected !== -1) return;
    setQuizSelected(idx);

    const isCorrect = idx === quizCorrectIndex;
    if (isCorrect) {
      setScore(prev => prev + 10);
      speak("Correct! Plus ten points!");
      showSub("Correct! +10 ⭐", 3000);
    } else {
      const correct = quizOptions[quizCorrectIndex];
      speak(`Wrong. It's ${correct}`);
      showSub(`Wrong! It's ${correct}`, 3000);
    }

    setTimeout(() => {
      setQuizActive(false);
      setQuizSelected(-1);
      speak("Click Start Detection to continue");
      showSub("Click Start Detection to continue", 4000);
      // VIDEO STAYS FROZEN UNTIL USER CLICKS START DETECTION
    }, 3500);
  };

  return (
    <div className="app-wrap">
      <div className="bg-anim"></div>
      <div className="bg-anim star-layer"></div>

      <div className="container">
        <header className="page-header">
          <h1 className="page-title">Object Detector Game for Kids</h1>
          <div style={{ textAlign: "center", fontSize: "2.5rem", fontWeight: "bold", color: "#f59e0b", margin: "10px 0" }}>
            Score: {score} ⭐
          </div>
        </header>

        <div className="card" style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16 }}>
          <video ref={videoRef} autoPlay muted playsInline className="media" />
          <DetectionCanvas video={videoRef.current} detections={detections} />
        </div>

        <div className="card" style={{ padding: 16, textAlign: "center" }}>
          <button onClick={() => {
            setRunning(r => !r);
            if (!running) setDetectionPaused(false); // ONLY RESUMES WHEN CLICKED
          }} className="btn btn-green">
            {running ? "Pause" : "Start"} Detection
          </button>

          <button onClick={switchCamera} className="btn btn-blue" style={{ margin: "0 8px" }}>
            {currentFacingMode === "environment" ? "Front" : "Back"} Camera
          </button>

          <button 
            onClick={() => {
              setDetectionPaused(true); // FREEZE ON CLICK
              setShowQuizSelection(true);
            }} 
            disabled={!best} 
            className={`btn btn-violet ${!best ? 'btn-grey' : ''}`}
          >
            Start Quiz
          </button>

          <button onClick={speakTop} className="btn btn-amber">Speak</button>

          <div style={{ marginTop: 10, opacity: 0.8 }}>
            Latency: {latency ? `${latency}ms` : "-"} • Top: {best?.cls || "-"}
          </div>
        </div>

        {showQuizSelection && !quizActive && (
          <div className="card" style={{ padding: 20 }}>
            <h3 style={{ color: "white" }}>Choose Quiz</h3>
            <div style={{ display: "flex", flexWrap: "wrap", gap: 12, justifyContent: "center" }}>
              <button onClick={() => { startObjectQuiz(); setShowQuizSelection(false); }} className="btn btn-violet">Name the Object</button>
              <button onClick={() => { startColorQuiz(); setShowQuizSelection(false); }} className="btn btn-violet">What Color?</button>
              <button onClick={() => { startDescriptionQuiz(); setShowQuizSelection(false); }} className="btn btn-violet">Description</button>
            </div>
            <button onClick={() => setShowQuizSelection(false)} style={{ marginTop: 12 }}>Cancel</button>
          </div>
        )}

        {quizActive && (
          <div className="card" style={{ padding: 24, marginTop: 20 }}>
            <h3 style={{ color: "white", textAlign: "center" }}>
              {quizType === "object" ? "What object is this?" : quizType === "color" ? "What is the color?" : "Choose the description"}
            </h3>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 14 }}>
              {quizOptions.map((opt, i) => (
                <button key={i} onClick={() => chooseAnswer(i)} disabled={quizSelected !== -1}
                  style={{
                    padding: 18, borderRadius: 16, fontWeight: "bold", fontSize: "1.1rem",
                    background: quizSelected === i ? (i === quizCorrectIndex ? "#22c55e" : "#ef4444") : "#fff",
                    color: quizSelected === i ? "white" : "black"
                  }}>
                  {opt}
                </button>
              ))}
            </div>
          </div>
        )}

        {subtitle && <div className="sub-banner">{subtitle}</div>}
      </div>
    </div>
  );
}

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);

    </script>
  </body>
</html>
